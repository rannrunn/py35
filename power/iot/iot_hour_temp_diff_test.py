# coding: utf-8
import matplotlib.pyplot as plt
from matplotlib import font_manager, rc
import MySQLdb
import time
import datetime
import numpy as np
import pandas as pd
import os, sys
import multiprocessing as mp

font_name = font_manager.FontProperties(fname="c:/Windows/Fonts/malgun.ttf").get_name()
rc('font', family=font_name)

# SELECT 하는 방법
def select(table, cur, pole_id, time_start, time_end):
    query = """SELECT DATE_FORMAT(CONCAT(CONVERT(COLUMN_MINUTE, CHAR(16)), '00'), '%%Y-%%m-%%d %%H:%%i') AS COLUMN_MINUTE,POLE_ID
                , (CASE WHEN BB_AVG_TEMP IS NOT NULL AND JJ_AVG_TEMP IS NOT NULL THEN BB_AVG_TEMP - JJ_AVG_TEMP ELSE 0 END) AS BB_JJ_DIFF
                FROM TB_IOT_POLE_MINUTE_AVG_TEMP 
                WHERE POLE_ID = '%s' AND COLUMN_MINUTE BETWEEN '%s' AND '%s' 
                ORDER BY COLUMN_MINUTE""" % (pole_id, time_start, time_end)
    print(query)
    cur.execute(query);
    results = cur.fetchall()
    list = []
    for row in results:
        list.append(row)

    return list

def make_x_arange(x_src, interval):
    return np.arange(min(x_src), max(x_src)+1, interval)

def make_x_tick(list_data, list_cnt):
    list = []
    for cnt in list_cnt:
        list.append(list_data[cnt])
    return list

def set_subplot(axes, axes_name, axes_data, x_sequence, x_arange, x_ticks, axes_xlim, axes_ylim):
    axes.plot(x_sequence, axes_data)
    axes.set_xticks(x_arange)
    axes.set_xticklabels(x_ticks)
    axes.set_ylabel(axes_name)
    axes.set_ylim( [axes_xlim, axes_ylim] )

def date_add(time, cnt):

    pass

def saveimage(filename):

    pass

if __name__ == '__main__':

    start = time.time()

    con = MySQLdb.connect('localhost', 'root', '1111', 'kepco')
    con.set_character_set('utf8')
    cur = con.cursor(MySQLdb.cursors.DictCursor)
    cur.execute('SET NAMES utf8;')
    cur.execute('SET CHARACTER SET utf8;')
    cur.execute('SET character_set_connection=utf8;')

    list_data = [

        ['8132W231','20160829'],
        ['8132W212','20160903'],
        ['8132W231','20160828'],
        ['8132W231','20160820'],
        ['8132W231','20161012'],
        ['8132W832','20161117'],
        ['8132W832','20160901'],
        ['8132W832','20160829'],
        ['8132W212','20160908'],
        ['8132W231','20161017'],
        ['8132W832','20160807'],
        ['8132W212','20160924'],
        ['8132W231','20160826'],
        ['8132W212','20170415'],
        ['8132W212','20160831'],
        ['8132W231','20160827'],
        ['8132W133','20160927'],
        ['8132W212','20170421'],
        ['8132W133','20161005'],
        ['8132W811','20161007'],
        ['8132W231','20161022'],
        ['8132W621','20160904'],
        ['8132W212','20160718'],
        ['8132Z092','20170509'],
        ['8132W212','20160921'],
        ['8132W133','20161112'],
        ['8132X122','20170430'],
        ['8132W832','20161118'],
        ['8132W832','20170507'],
        ['8132W811','20161003'],
        ['8132W832','20161121'],
        ['8132W832','20161029'],
        ['8132W231','20161110'],
        ['8132X122','20160831'],
        ['8132X122','20161011'],
        ['8132W212','20161106'],
        ['8132W811','20161121'],
        ['8132W832','20170503'],
        ['8132W832','20161003'],
        ['8132W832','20161105'],
        ['8132W811','20160903'],
        ['8132W832','20160430'],
        ['8132Z092','20161105'],
        ['8132W212','20161022'],
        ['8132W832','20161115'],
        ['8132W212','20170426'],
        ['8132X122','20161021'],
        ['8132W133','20160820'],
        ['8132W212','20160828'],
        ['8132W832','20160902'],
        ['8132Z092','20161029'],
        ['8132X201','20161011'],
        ['8132W133','20160827'],
        ['8132W811','20170425'],
        ['8132W832','20170417'],
        ['8132W811','20160807'],
        ['8132W811','20161030'],
        ['8132W621','20161029'],
        ['8132X122','20161109'],
        ['8132W621','20161106'],
        ['8132X122','20170509'],
        ['8132W212','20161119'],
        ['8132W212','20161004'],
        ['8132X122','20160820'],
        ['8132W621','20160825'],
        ['8132W212','20160907'],
        ['8132W811','20161012'],
        ['8132W133','20160720'],
        ['8132W231','20161020'],
        ['8132X122','20161022'],
        ['8132W212','20170416'],
        ['8132W231','20160821'],
        ['8132W621','20170425'],
        ['8132W621','20160717'],
        ['8132W621','20170414'],
        ['8132W133','20160717'],
        ['8132W212','20160825'],
        ['8132W811','20170501'],
        ['8132W832','20160908'],
        ['8132W621','20160830'],
        ['8132X201','20161106'],
        ['8132W621','20170419'],
        ['8132Z092','20161014'],
        ['8132W212','20161122'],
        ['8132W231','20160918'],
        ['8132W212','20160901'],
        ['8132Z092','20160822'],
        ['8132W231','20160819'],
        ['8132W231','20161124'],
        ['8132W133','20160809'],
        ['8132W621','20161018'],
        ['8132X122','20161124'],
        ['8132X122','20161014'],
        ['8132W231','20170421'],
        ['8132X122','20161020'],
        ['8132W212','20160917'],
        ['8132X122','20161123'],
        ['8132W832','20161113'],
        ['8132W621','20160806'],
        ['8132X122','20170423'],
        ['8132W832','20160723'],
        ['8132W212','20161112'],
        ['8132W821','20160723'],
        ['8132W811','20160821'],
        ['8132W821','20160906'],
        ['8132W811','20160905'],
        ['8132W832','20161110'],
        ['8132W212','20170414'],
        ['8132X122','20160823'],
        ['8132W621','20160927'],
        ['8132W133','20160716'],
        ['8132W212','20170506'],
        ['8132Z092','20170504'],
        ['8132X122','20161117'],
        ['8132X122','20160923'],
        ['8132X122','20161016'],
        ['8132W832','20160827'],
        ['8132X122','20161106'],
        ['8132W811','20160818'],
        ['8132Z092','20160923'],
        ['8132X782','20160724'],
        ['8132W832','20160722'],
        ['8132X122','20161019'],
        ['8132W212','20160819'],
        ['8132W231','20161018'],
        ['8132W212','20161109'],
        ['8132X122','20160830'],
        ['8132W212','20161116'],
        ['8132X201','20160501'],
        ['8132W212','20160822'],
        ['8132W212','20161101'],
        ['8132W212','20161114'],
        ['8132X201','20160920'],
        ['8132W811','20170423'],
        ['8132W621','20160824'],
        ['8132X122','20161029'],
        ['8132X201','20160928'],
        ['8132W133','20160912'],
        ['8132X201','20161113'],
        ['8132X201','20160913'],
        ['8132W231','20160917'],
        ['8132W212','20160829'],
        ['8132W832','20161024'],
        ['8132W212','20170425'],
        ['8132W832','20161023'],
        ['8132W821','20160824'],
        ['8132W832','20170501'],
        ['8132W811','20160912'],
        ['8132W212','20161121'],
        ['8132W621','20161008'],
        ['8132W133','20161119'],
        ['8132W621','20170423'],
        ['8132W621','20160922'],
        ['8132Z092','20160721'],
        ['8132X122','20160907'],
        ['8132W212','20170417'],
        ['8132W621','20161117'],
        ['8132W212','20160719'],
        ['8132W133','20170415'],
        ['8132X122','20170506'],
        ['8132W832','20161124'],
        ['8132W621','20160826'],
        ['8132W212','20170509'],
        ['8132W811','20160904'],
        ['8132Z092','20160904'],
        ['8132W821','20160908'],
        ['8132W231','20170420'],
        ['8132W621','20160925'],
        ['8132W832','20161122'],
        ['8132W231','20160825'],
        ['8132X201','20160502'],
        ['8132W231','20161109'],
        ['8132W231','20161119'],
        ['8132W621','20160724'],
        ['8132W231','20161031'],
        ['8132Z092','20160828'],
        ['8132W811','20160826'],
        ['8132W231','20160916'],
        ['8132X122','20170414'],
        ['8132W212','20160817'],
        ['8132W212','20161103'],
        ['8132W821','20160826'],
        ['8132W621','20170429'],
        ['8132W212','20170423'],
        ['8132Z092','20170508'],
        ['8132W133','20170416'],
        ['8132X122','20160910'],
        ['8132W133','20161107'],
        ['8132X122','20161018'],
        ['8132W811','20161104'],
        ['8132W811','20160901'],
        ['8132Z092','20160807'],
        ['8132W821','20160915'],
        ['8132W231','20161021'],
        ['8132W832','20161009'],
        ['8132Z092','20161118'],
        ['8132W231','20160817'],
        ['8132W231','20161019'],
        ['8132W212','20160927'],
        ['8132X122','20161002'],
        ['8132W832','20161004'],
        ['8132W821','20160925'],
        ['8132X201','20161111'],
        ['8132W621','20161003'],
        ['8132X201','20160423'],
        ['8132X201','20161008'],
        ['8132W811','20161009'],
        ['8132X201','20160428'],
        ['8132W621','20160823'],
        ['8132W621','20160923'],
        ['8132X122','20160928'],
        ['8132W133','20161104'],
        ['8132W821','20160830'],
        ['8132X122','20161005'],
        ['8132X201','20161010'],
        ['8132W212','20161124'],
        ['8132W821','20160914'],
        ['8132Z092','20170501'],
        ['8132W231','20170422'],
        ['8132W811','20160925'],
        ['8132W811','20161011'],
        ['8132W832','20161123'],
        ['8132W212','20161009'],
        ['8132Z092','20160917'],
        ['8132W133','20160719'],
        ['8132W133','20160805'],
        ['8132W133','20170414'],
        ['8132Z815','20160910'],
        ['8132W811','20161016'],
        ['8132W621','20161122'],
        ['8132Z092','20160810'],
        ['8132W811','20161113'],
        ['8132W133','20160924'],
        ['8132X122','20160718'],
        ['8132X122','20170503'],
        ['8132W133','20160930'],
        ['8132X122','20161006'],
        ['8132W133','20160804'],
        ['8132X122','20161013'],
        ['8132W811','20161020'],
        ['8132Z092','20161113'],
        ['8132W212','20160911'],
        ['8132Z815','20160913'],
        ['8132W832','20161111'],
        ['8132X201','20161004'],
        ['8132W832','20161015'],
        ['8132X122','20170425'],
        ['8132W231','20160822'],
        ['8132Z092','20161028'],
        ['8132Z092','20160924'],
        ['8132W811','20160426'],
        ['8132W133','20160902'],
        ['8132X201','20160722'],
        ['8132W811','20170504'],
        ['8132W832','20161013'],
        ['8132X122','20160926'],
        ['8132W811','20160923'],
        ['8132W832','20170427'],
        ['8132X122','20160917'],
        ['8132W621','20161022'],
        ['8132W832','20161028'],
        ['8132W621','20160821'],
        ['8132Z092','20160424'],
        ['8132W811','20160913'],
        ['8132W832','20161014'],
        ['8132X201','20160925'],
        ['8132W231','20160923'],
        ['8132W621','20170502'],
        ['8132Z815','20160903'],
        ['8132W832','20161102'],
        ['8132W832','20170506'],
        ['8132Z092','20161011'],
        ['8132W821','20170421'],
        ['8132Z092','20160724'],
        ['8132W133','20161117'],
        ['8132Z092','20160909'],
        ['8132Z092','20161119'],
        ['8132W231','20161023'],
        ['8132W821','20170417'],
        ['8132W821','20160820'],
        ['8132Z092','20161004'],
        ['8132Z092','20160503'],
        ['8132W621','20161004'],
        ['8132Z092','20160829'],
        ['8132W621','20160725'],
        ['8132W133','20161111'],
        ['8132W231','20170428'],
        ['8132W212','20160912'],
        ['8132W832','20161109'],
        ['8132W832','20160806'],
        ['8132W212','20160910'],
        ['8132X782','20160716'],
        ['8132W133','20161028'],
        ['8132X122','20160920'],
        ['8132W212','20160922'],
        ['8132W832','20161008'],
        ['8132W811','20160502'],
        ['8132W133','20161121'],
        ['8132W832','20160906'],
        ['8132W133','20160823'],
        ['8132X201','20161108'],
        ['8132Z815','20160826'],
        ['8132W212','20161107'],
        ['8132W621','20160906'],
        ['8132W811','20160428'],
        ['8132W832','20170418'],
        ['8132W621','20170501'],
        ['8132W212','20161110'],
        ['8132W832','20170416'],
        ['8132W621','20160827'],
        ['8132W811','20161031'],
        ['8132W832','20160429'],
        ['8132W811','20160805'],
        ['8132X201','20161024'],
        ['8132W212','20160805'],
        ['8132W832','20160824'],
        ['8132W133','20160818'],
        ['8132Z092','20161117'],
        ['8132W621','20160911'],
        ['8132Z092','20170419'],
        ['8132W811','20161028'],
        ['8132X122','20170427'],
        ['8132W832','20161016'],
        ['8132X201','20160915'],
        ['8132W832','20160718'],
        ['8132W611','20160826'],
        ['8132Z092','20160716'],
        ['8132W133','20160825'],
        ['8132Z092','20160825'],
        ['8132W621','20160909'],
        ['8132Z092','20160429'],
        ['8132W231','20161123'],
        ['8132X122','20160804'],
        ['8132Z815','20160722'],
        ['8132W133','20170427'],
        ['8132W811','20161116'],
        ['8132W621','20160718'],
        ['8132W212','20160830'],
        ['8132W621','20160928'],
        ['8132W811','20160425'],
        ['8132W821','20161121'],
        ['8132W133','20161122'],
        ['8132W212','20160809'],
        ['8132W212','20161007'],
        ['8132W811','20160902'],
        ['8132X122','20160808'],
        ['8132W832','20160804'],
        ['8132W811','20160722'],
        ['8132W212','20160823'],
        ['8132W621','20160818'],
        ['8132W811','20161017'],
        ['8132W811','20161015'],
        ['8132X201','20170427'],
        ['8132Z092','20161121'],
        ['8132W832','20160724'],
        ['8132Z092','20160902'],
        ['8132X201','20160930'],
        ['8132W212','20160807'],
        ['8132X122','20161003'],
        ['8132W212','20161111'],
        ['8132W133','20161115'],
        ['8132Z815','20160901'],
        ['8132X201','20161107'],
        ['8132X122','20161110'],
        ['8132W212','20161028'],
        ['8132W133','20160831'],
        ['8132X122','20161024'],
        ['8132W621','20170422'],
        ['8132Z092','20161102'],
        ['8132W821','20161012'],
        ['8132Z092','20170423'],
        ['8132X122','20160807'],
        ['8132Z092','20160911'],
        ['8132W821','20161107'],
        ['8132W231','20160919'],
        ['8132W811','20161105'],
        ['8132W621','20161019'],
        ['8132W832','20160928'],
        ['8132W811','20160721'],
        ['8132W811','20161004'],
        ['8132X122','20161111'],
        ['8132W821','20161006'],
        ['8132W133','20160724'],
        ['8132W133','20160919'],
        ['8132X201','20161105'],
        ['8132W212','20161104'],
        ['8132Z092','20160925'],
        ['8132W832','20161006'],
        ['8132W231','20161111'],
        ['8132X201','20160828'],
        ['8132W212','20161030'],
        ['8132W231','20160924'],
        ['8132W832','20160910'],
        ['8132Z815','20160806'],
        ['8132X122','20160827'],
        ['8132W821','20160720'],
        ['8132W621','20160804'],
        ['8132X201','20160725'],
        ['8132W621','20170424'],
        ['8132W621','20161108'],
        ['8132W811','20160806'],
        ['8132W133','20160904'],
        ['8132W621','20161114'],
        ['8132W811','20161101'],
        ['8132W133','20160910'],
        ['8132W133','20170423'],
        ['8132W621','20160903'],
        ['8132X201','20160808'],
        ['8132W832','20160907'],
        ['8132Z092','20161022'],
        ['8132W212','20170430'],
        ['8132W811','20160429'],
        ['8132W811','20161122'],
        ['8132Z092','20160804'],
        ['8132X201','20170420'],
        ['8132W133','20160830'],
        ['8132W231','20160804'],
        ['8132W811','20160909'],
        ['8132Z092','20161106'],
        ['8132Z092','20161110'],
        ['8132W621','20161113'],
        ['8132W832','20160501'],
        ['8132X201','20160923'],
        ['8132W811','20161014'],
        ['8132W621','20161112'],
        ['8132W811','20161119'],
        ['8132W212','20161108'],
        ['8132Z092','20160916'],
        ['8132Z092','20161007'],
        ['8132W621','20160807'],
        ['8132W133','20160922'],
        ['8132W832','20160828'],
        ['8132X201','20160805'],
        ['8132W832','20160502'],
        ['8132W133','20160905'],
        ['8132W212','20160909'],
        ['8132W811','20161107'],
        ['8132X201','20170501'],
        ['8132X122','20170502'],
        ['8132X782','20160720'],
        ['8132X122','20160915'],
        ['8132W611','20170417'],
        ['8132Z092','20160824'],
        ['8132Z092','20161116'],
        ['8132W133','20161019'],
        ['8132W133','20161108'],
        ['8132W231','20160424'],
        ['8132X122','20160819'],
        ['8132W621','20161118'],
        ['8132W811','20160810'],
        ['8132W832','20160826'],
        ['8132Z092','20170421'],
        ['8132W821','20170429'],
        ['8132W133','20160917'],
        ['8132W212','20160827'],
        ['8132Z092','20161112'],
        ['8132X201','20161012'],
        ['8132W821','20160902'],
        ['8132W811','20160827'],
        ['8132W832','20160912'],
        ['8132W212','20161123'],
        ['8132X201','20161115'],
        ['8132X201','20161118'],
        ['8132X201','20160823'],
        ['8132W133','20160928'],
        ['8132Z815','20160821'],
        ['8132W621','20161015'],
        ['8132Z815','20160908'],
        ['8132W621','20160924'],
        ['8132W231','20161101'],
        ['8132W821','20161031'],
        ['8132X122','20160722'],
        ['8132X201','20160919'],
        ['8132W811','20170416'],
        ['8132Z815','20160824'],
        ['8132X122','20170429'],
        ['8132W133','20170417'],
        ['8132W212','20160723'],
        ['8132W212','20161117'],
        ['8132Z092','20160722'],
        ['8132W621','20161116'],
        ['8132X122','20161116'],
        ['8132X201','20161014'],
        ['8132Z815','20160905'],
        ['8132W821','20161010'],
        ['8132X122','20160927'],
        ['8132W811','20160723'],
        ['8132W821','20161008'],
        ['8132W611','20170421'],
        ['8132W621','20160716'],
        ['8132X122','20161012'],
        ['8132W811','20170509'],
        ['8132Z092','20160907'],
        ['8132W611','20170507'],
        ['8132W231','20161114'],
        ['8132W611','20160924'],
        ['8132X201','20160720'],
        ['8132W231','20161028'],
        ['8132W212','20170424'],
        ['8132W231','20170416'],


    ]


    for l_pole, l_time in list_data:
        table = 'TB_IOT_POLE_MINUTE_AVG_TEMP'

        pole_id = l_pole
        time_date = l_time
        time_start = time_date + '0000'
        time_end = time_date + '2359'

        list_mon = select(table, cur, pole_id, time_start, time_end)
        # list_tue = select(table, cur, pole_id, time_start, time_end)
        # list_wed = select(table, cur, pole_id, time_start, time_end)
        # list_thu = select(table, cur, pole_id, time_start, time_end)
        # list_fri = select(table, cur, pole_id, time_start, time_end)
        # list_sat = select(table, cur, pole_id, time_start, time_end)
        # list_sun = select(table, cur, pole_id, time_start, time_end)

        df = pd.DataFrame(list_mon)
        COLUMN_MINUTE = df.COLUMN_MINUTE.values
        BB_JJ_DIFF = df.BB_JJ_DIFF.values


        x_sequence = [i for i in range(len(COLUMN_MINUTE))]
        print(COLUMN_MINUTE)
        print(x_sequence)
        print(type(BB_JJ_DIFF))

        x_arange_top = make_x_arange(x_sequence, 180)
        x_ticks_top = make_x_tick(COLUMN_MINUTE, x_arange_top)
        fig = plt.figure(figsize=(15, 13))
        ax1 = fig.add_subplot(1, 1, 1)
        fig.suptitle(pole_id)
        # axes, axes_name, axes_data, x_sequence, x_arange, x_ticks, axes_xlim, axes_ylim


        print('BB_JJ_DIFF:', BB_JJ_DIFF)

        myDatetime = datetime.datetime.strptime('20150415232338', '%Y%m%d%H%M%S')
        #print(myDatetime. )

        x_arange_bottom = make_x_arange(x_sequence, 60)
        x_ticks_bottom = make_x_tick(COLUMN_MINUTE, x_arange_bottom)
        ax1.plot(x_sequence, BB_JJ_DIFF, label='변압기 - 전주')
        ax1.set_xticks(x_arange_bottom)
        ax1.set_xticklabels(x_ticks_bottom, rotation='vertical')
        ax1.set_ylim( [-5, 15] )

        print('past time:', time.time() - start)
        plt.legend()
        plt.show()




